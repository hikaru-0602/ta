# ğŸ”§ GitHub Actions CIè¨­å®š
# ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã€ã‚³ãƒ¼ãƒ‰ãŒãƒ—ãƒƒã‚·ãƒ¥ã•ã‚ŒãŸæ™‚ã«è‡ªå‹•ã§ãƒ†ã‚¹ãƒˆã¨ãƒ“ãƒ«ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™

name: CI

# ğŸš€ ã„ã¤CIã‚’å®Ÿè¡Œã™ã‚‹ã‹
on:
  push:
    branches: [main, develop] # mainã¨developãƒ–ãƒ©ãƒ³ãƒã«ãƒ—ãƒƒã‚·ãƒ¥ã•ã‚ŒãŸæ™‚
  pull_request:
    branches: [main] # mainãƒ–ãƒ©ãƒ³ãƒã¸ã®ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ™‚

# ğŸ’¼ ä¸¦è¡Œå®Ÿè¡Œã®åˆ¶å¾¡ï¼ˆåŒã˜ãƒ–ãƒ©ãƒ³ãƒã®å¤ã„CIã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ï¼‰
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# ğŸ” Firebaseç’°å¢ƒå¤‰æ•°ã®è¨­å®šï¼ˆå…¨ä½“ï¼‰
env:
  NEXT_PUBLIC_API_KEY: ${{ secrets.NEXT_PUBLIC_API_KEY }}
  NEXT_PUBLIC_AUTH_DOMAIN: ${{ secrets.NEXT_PUBLIC_AUTH_DOMAIN }}
  NEXT_PUBLIC_PROJECT_ID: ${{ secrets.NEXT_PUBLIC_PROJECT_ID }}
  NEXT_PUBLIC_STORAGE_BUCKET: ${{ secrets.NEXT_PUBLIC_STORAGE_BUCKET }}
  NEXT_PUBLIC_MESSAGING_SENDER_ID: ${{ secrets.NEXT_PUBLIC_MESSAGING_SENDER_ID }}
  NEXT_PUBLIC_APP_ID: ${{ secrets.NEXT_PUBLIC_APP_ID }}
  NEXT_PUBLIC_MEASUREMENT_ID: ${{ secrets.NEXT_PUBLIC_MEASUREMENT_ID }}
  NEXT_PUBLIC_RECAPTCHA_SITE_KEY: ${{ secrets.NEXT_PUBLIC_RECAPTCHA_SITE_KEY }}

# ğŸ› ï¸ å®Ÿè¡Œã™ã‚‹ä½œæ¥­ã®å®šç¾©
jobs:
  test:
    name: ğŸ§ª ãƒ†ã‚¹ãƒˆã¨ãƒ“ãƒ«ãƒ‰
    runs-on: ubuntu-latest # Ubuntuç’°å¢ƒã§å®Ÿè¡Œ

    strategy:
      matrix:
        node-version: [18, 20] # Node.js 18ã¨20ã§ãƒ†ã‚¹ãƒˆ

    steps:
      # ğŸ“¥ ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã®å–å¾—
      - name: ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      # ğŸŸ¢ Node.jsã®ç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      - name: Node.js ${{ matrix.node-version }} ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: "npm" # npm ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’æœ‰åŠ¹åŒ–

      # ğŸ“¦ ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      - name: ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: npm ci

      # ğŸ” å‹ãƒã‚§ãƒƒã‚¯ï¼ˆTypeScriptï¼‰
      - name: TypeScriptå‹ãƒã‚§ãƒƒã‚¯
        run: npm run type-check

      # ğŸ§ª ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œ
      - name: ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
        run: npm run test:ci

      # ğŸ—ï¸ ãƒ“ãƒ«ãƒ‰ã®ç¢ºèª
      - name: Next.jsãƒ“ãƒ«ãƒ‰
        run: npm run build

  # ğŸ“Š ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ã®è¨ˆæ¸¬ï¼ˆè¿½åŠ ã® jobï¼‰
  coverage:
    name: ğŸ“Š ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' # ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ™‚ã®ã¿å®Ÿè¡Œ

    steps:
      - name: ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: Node.js ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"

      - name: ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: npm ci

      - name: ã‚«ãƒãƒ¬ãƒƒã‚¸ä»˜ããƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        run: npm run test -- --coverage --watchAll=false

      # ğŸ“ˆ ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆã‚’ã‚³ãƒ¡ãƒ³ãƒˆã«è¡¨ç¤º
      - name: ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆã‚’PRã«ã‚³ãƒ¡ãƒ³ãƒˆ
        uses: romeovs/lcov-reporter-action@v0.3.1
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          lcov-file: ./coverage/lcov.info
        continue-on-error: true
